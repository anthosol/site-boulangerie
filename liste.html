<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liste des produits</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    padding: 20px;
    color: #333;
    display: flex;
    justify-content: center;
  }
  .container {
    width: 800px;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
  }
  input#searchInput {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button.modifierBtn { background-color: #4CAF50; color: white; margin-right: 5px;}
  button.supprimerBtn { background-color: #f44336; color: white; }
  button:hover { opacity: 0.9; }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    text-align: left;
  }
  th {
    background: #4CAF50;
    color: white;
    font-weight: 600;
  }
  tr:hover { background-color: #f0f0f0; cursor: pointer; }
  .categorieTitre {
    background-color: #eee;
    font-weight: bold;
    text-align: left;
    color: #333;
  }
  td.nomCol { width: 250px; }
  td.codeCol { width: 100px; }
  td.actionBtns { width: 150px; text-align: center; }

  /* Modal formulaire */
  #formulaireModif {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    width: 400px;
  }
  #formulaireModif input, #formulaireModif select {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    box-sizing: border-box;
  }
  #overlay {
    display:none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.4);
    z-index: 900;
  }

  /* Boutons du formulaire de modification */
  #formulaireModif #btnModifier {
    background-color: #4CAF50; /* vert */
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 10px;
    cursor: pointer;
  }

  #formulaireModif #btnAnnuler {
    background-color: #f44336; /* rouge */
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 10px;
    cursor: pointer;
  }

  #formulaireModif button:hover {
    opacity: 0.9;
  }
</style>
</head>
<body>

<div id="overlay"></div>
<div class="container">
  <h1>Liste des produits</h1>
  <button onclick="window.location.href='index.html'">⬅ Retour</button>
  <input type="text" id="searchInput" placeholder="Rechercher un produit...">

  <table id="tableProduits">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Code</th>
        <th style="width:150px;">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Formulaire modification -->
<div id="formulaireModif">
  <h3>Modifier le produit</h3>
  <input type="text" id="modifNom" placeholder="Nom">
  <input type="text" id="modifCode" placeholder="Code">
  <select id="modifCategorie">
    <option value="">-- Choisir une catégorie --</option>
    <option value="Pains">Pains</option>
    <option value="Viennoiseries">Viennoiseries</option>
    <option value="Pâtisseries">Pâtisseries</option>
    <option value="Autres">Autres</option>
  </select>
  <div style="display:flex; gap:5px; justify-content:flex-end; margin-top:10px;">
    <button id="btnModifier">Modifier</button>
    <button id="btnAnnuler">Annuler</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDnHZLrdK0r84dA8mpqv-WQ53JligbBmdQ",
    authDomain: "produitsboulangerie.firebaseapp.com",
    projectId: "produitsboulangerie",
    storageBucket: "produitsboulangerie.appspot.com",
    messagingSenderId: "386119894944",
    appId: "1:386119894944:web:930d3b90dc27031a2b86c5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const tbody = document.querySelector("#tableProduits tbody");
  const searchInput = document.getElementById("searchInput");
  const overlay = document.getElementById("overlay");
  const formulaire = document.getElementById("formulaireModif");
  const inputNom = document.getElementById("modifNom");
  const inputCode = document.getElementById("modifCode");
  const selectCategorie = document.getElementById("modifCategorie");
  const btnModifier = document.getElementById("btnModifier");
  const btnAnnuler = document.getElementById("btnAnnuler");

  const categories = ["Pains", "Viennoiseries", "Pâtisseries", "Autres"];
  let produits = [];
  let produitSelectionne = null;

  function normaliserTexte(texte) {
    return texte.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function afficherProduits() {
    const filtre = normaliserTexte(searchInput.value);
    tbody.innerHTML = "";

    categories.forEach(categorie => {
      const produitsCategorie = produits
        .filter(p => (p.categorie || 'Autres') === categorie)
        .filter(p => normaliserTexte(p.nom).includes(filtre))
        .sort((a,b) => a.nom.localeCompare(b.nom, 'fr', {ignorePunctuation:true}));

      if(produitsCategorie.length === 0) return;

      const trCat = document.createElement("tr");
      trCat.className = "categorieTitre";
      trCat.innerHTML = `<td colspan="3">${categorie}</td>`;
      tbody.appendChild(trCat);

      produitsCategorie.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nomCol">${p.nom}</td>
          <td class="codeCol">${p.code}</td>
          <td class="actionBtns" style="visibility:hidden;">
            <button class="modifierBtn">Modifier</button>
            <button class="supprimerBtn">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);

        tr.onclick = (e) => {
          if(e.target.tagName.toLowerCase() === 'button') return;
          const btnCell = tr.querySelector(".actionBtns");
          btnCell.style.visibility = btnCell.style.visibility === "visible" ? "hidden" : "visible";
        };

        const modifierBtn = tr.querySelector(".modifierBtn");
        const supprimerBtn = tr.querySelector(".supprimerBtn");

        modifierBtn.onclick = () => {
          produitSelectionne = p;
          ouvrirFormulaire();
        };

        // Suppression directe sans popup
        supprimerBtn.onclick = async () => {
          await db.collection("produits").doc(p.id).delete();
        };
      });
    });
  }

  function ouvrirFormulaire() {
    inputNom.value = produitSelectionne.nom;
    inputCode.value = produitSelectionne.code;
    selectCategorie.value = produitSelectionne.categorie || "Autres";
    formulaire.style.display = "block";
    overlay.style.display = "block";
  }

  function annulerModification() {
    formulaire.style.display = "none";
    overlay.style.display = "none";
    produitSelectionne = null;
  }

  async function modifierProduit() {
    if(!inputNom.value || !inputCode.value || !selectCategorie.value) {
      alert("Veuillez remplir tous les champs");
      return;
    }
    await db.collection("produits").doc(produitSelectionne.id).update({
      nom: inputNom.value,
      code: inputCode.value,
      categorie: selectCategorie.value
    });
    annulerModification();
    afficherProduits();
  }

  db.collection("produits").onSnapshot(snapshot => {
    produits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    afficherProduits();
  });

  searchInput.addEventListener("input", afficherProduits);
  btnModifier.addEventListener("click", modifierProduit);
  btnAnnuler.addEventListener("click", annulerModification);
</script>

</body>
</html>
